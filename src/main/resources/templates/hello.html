<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹¤ì‹œê°„ ì±„íŒ… - MyTestWeb</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <h1 class="nav-title">MyTestWeb - ì‹¤ì‹œê°„ ì±„íŒ…</h1>
            <ul class="nav-menu">
                <li><a href="/" class="nav-link">í™ˆ</a></li>
                <li><a href="/hello" class="nav-link active">ì‹¤ì‹œê°„ ì±„íŒ…</a></li>
                <li><a href="/about" class="nav-link">ì†Œê°œ</a></li>
                <li th:if="${user != null}" class="user-info">
                    <span class="user-name" th:text="${user.username}"></span>
                    <a th:if="${user.isAdmin}" href="/admin" class="nav-link admin-link">ê´€ë¦¬ì</a>
                    <form th:action="@{/logout}" method="post" style="display: inline;">
                        <button type="submit" class="nav-link logout-link">ë¡œê·¸ì•„ì›ƒ</button>
                    </form>
                </li>
                <li th:unless="${user != null}">
                    <a href="/login" class="nav-link">ë¡œê·¸ì¸</a>
                    <a href="/register" class="nav-link">íšŒì›ê°€ì…</a>
                </li>
            </ul>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            <div class="chat-container">
                <div class="chat-header">
                    <h2>ì‹¤ì‹œê°„ ì±„íŒ…ë°©</h2>
                    <div class="online-users">
                        <span id="online-count">0</span>ëª… ì ‘ì† ì¤‘
                    </div>
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    <!-- ê¸°ì¡´ ë©”ì‹œì§€ë“¤ -->
                    <div th:each="message : ${recentMessages}" class="message" th:classappend="${message.messageType.name().toLowerCase()}">
                        <div class="message-content">
                            <span class="message-username" th:text="${message.username}"></span>
                            <span class="message-text" th:text="${message.message}"></span>
                            <span class="message-time" th:text="${#temporals.format(message.createdAt, 'HH:mm')}"></span>
                        </div>
                    </div>
                </div>
                
                <div class="chat-input-container">
                    <div class="user-input-section" id="userInputSection">
                        <div class="welcome-message" th:if="${currentUsername != null}">
                            <span th:text="'ì•ˆë…•í•˜ì„¸ìš”, ' + ${currentUsername} + 'ë‹˜! ì±„íŒ…ë°©ì— ì…ì¥í•˜ì„¸ìš”.'"></span>
                        </div>
                        <div class="welcome-message" th:if="${currentUsername == null}">
                            <span>ì‹¤ì‹œê°„ ì±„íŒ…ë°©ì— ì…ì¥í•˜ì„¸ìš”!</span>
                            <br><small class="text-muted">ê²ŒìŠ¤íŠ¸ ì‚¬ìš©ìëª…ìœ¼ë¡œ ì±„íŒ…ë©ë‹ˆë‹¤.</small>
                        </div>
                        <button id="joinButton" class="btn btn-primary">ì±„íŒ…ë°© ì…ì¥</button>
                    </div>
                    
                    <div class="message-input-section" id="messageInputSection" style="display: none;">
                        <div class="input-group">
                            <input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." maxlength="500">
                            <button id="sendButton" class="btn btn-primary">ì „ì†¡</button>
                        </div>
                        <div class="typing-indicator" id="typingIndicator" style="display: none;">
                            <span id="typingUsers"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        let stompClient = null;
        let username = null;
        let typingTimer = null;
        let onlineUsers = new Set();
        let heartbeatInterval = null;
        
        // ì„œë²„ì—ì„œ ì „ë‹¬ëœ ì‚¬ìš©ìëª… í™•ì¸
        const currentUsername = /*[[${currentUsername}]]*/ null;
        
        // ë””ë²„ê¹…: í˜ì´ì§€ ë¡œë“œ ì‹œ ì‚¬ìš©ìëª… í™•ì¸
        console.log('=== í˜ì´ì§€ ë¡œë“œ ì‹œ ì‚¬ìš©ìëª… í™•ì¸ ===');
        console.log('currentUsername:', currentUsername);
        console.log('currentUsername íƒ€ì…:', typeof currentUsername);
        console.log('currentUsername === null:', currentUsername === null);
        console.log('currentUsername === "null":', currentUsername === "null");
        
        // ì¶”ê°€ ë””ë²„ê¹…: ì‚¬ìš©ì ì •ë³´ í™•ì¸
        const userElement = document.querySelector('.user-name');
        if (userElement) {
            console.log('ë„¤ë¹„ê²Œì´ì…˜ì—ì„œ ì‚¬ìš©ìëª… ë°œê²¬:', userElement.textContent);
        } else {
            console.log('ë„¤ë¹„ê²Œì´ì…˜ì—ì„œ ì‚¬ìš©ìëª…ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ');
        }

        // ì±„íŒ…ë°© ì…ì¥ ë²„íŠ¼ (í†µí•©)
        const joinButton = document.getElementById('joinButton');
        if (joinButton) {
            joinButton.addEventListener('click', function() {
                console.log('=== ì±„íŒ…ë°© ì…ì¥ ë²„íŠ¼ í´ë¦­ë¨ ===');
                console.log('currentUsername ê°’:', currentUsername);
                console.log('currentUsername íƒ€ì…:', typeof currentUsername);
                
                // ì‚¬ìš©ìëª… ì„¤ì •
                let finalUsername = null;
                
                if (currentUsername && currentUsername !== 'null' && currentUsername.trim() !== '') {
                    // ì„œë²„ì—ì„œ ì „ë‹¬ëœ ì‚¬ìš©ìëª… ì‚¬ìš©
                    finalUsername = currentUsername;
                    console.log('âœ… ì„œë²„ì—ì„œ ì „ë‹¬ëœ ì‚¬ìš©ìëª… ì‚¬ìš©:', finalUsername);
                } else {
                    // ë„¤ë¹„ê²Œì´ì…˜ì—ì„œ ì‚¬ìš©ìëª… í™•ì¸
                    const userElement = document.querySelector('.user-name');
                    if (userElement && userElement.textContent.trim() !== '') {
                        finalUsername = userElement.textContent.trim();
                        console.log('âœ… ë„¤ë¹„ê²Œì´ì…˜ì—ì„œ ì‚¬ìš©ìëª… ë°œê²¬:', finalUsername);
                    }
                }
                
                if (finalUsername) {
                    // ë¡œê·¸ì¸í•œ ì‚¬ìš©ì - ì‹¤ì œ ì•„ì´ë”” ì‚¬ìš©
                    username = finalUsername;
                    console.log('âœ… ë¡œê·¸ì¸ ì‚¬ìš©ì ì…ì¥:', username);
                } else {
                    // ë¹„ë¡œê·¸ì¸ ì‚¬ìš©ì - ê²ŒìŠ¤íŠ¸ ì‚¬ìš©ìëª… ì‚¬ìš©
                    username = 'Guest_' + Math.random().toString(36).substr(2, 9);
                    console.log('ğŸ‘¤ ê²ŒìŠ¤íŠ¸ ì‚¬ìš©ì ì…ì¥:', username);
                }
                
                console.log('ìµœì¢… ì„¤ì •ëœ username:', username);
                
                // WebSocket ì—°ê²°
                connect();
                
                // UI ì „í™˜
                document.getElementById('userInputSection').style.display = 'none';
                document.getElementById('messageInputSection').style.display = 'block';
            });
        }

        // WebSocket ì—°ê²°
        function connect() {
            console.log('=== WebSocket ì—°ê²° ì‹œì‘ ===');
            console.log('ì‚¬ìš©ìëª…:', username);
            console.log('í˜„ì¬ ë¡œê·¸ì¸ ì‚¬ìš©ì:', currentUsername);
            console.log('ì‚¬ìš©ìëª… íƒ€ì…:', currentUsername ? 'ë¡œê·¸ì¸ ì‚¬ìš©ì' : 'ê²ŒìŠ¤íŠ¸ ì‚¬ìš©ì');
            
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            
            // ë””ë²„ê·¸ ëª¨ë“œ í™œì„±í™”
            stompClient.debug = function(str) {
                console.log('STOMP Debug:', str);
            };
            
        stompClient.connect({}, function(frame) {
            console.log('âœ… WebSocket ì—°ê²° ì„±ê³µ!');
            console.log('Frame:', frame);
            
            // ì ‘ì†ì ìˆ˜ ì´ˆê¸°í™”
            onlineUsers.clear();
            onlineUsers.add(username);
            updateOnlineCount();
            console.log('ì´ˆê¸° ì ‘ì†ì ìˆ˜ ì„¤ì •:', onlineUsers.size);
            
            // ì‚¬ìš©ì ì…ì¥ ë©”ì‹œì§€ ì „ì†¡
            const joinMessage = {
                username: username,
                messageType: 'JOIN'
            };
            console.log('ì…ì¥ ë©”ì‹œì§€ ì „ì†¡:', joinMessage);
            stompClient.send("/app/chat.addUser", {}, JSON.stringify(joinMessage));
            
            // ë©”ì‹œì§€ êµ¬ë…
            stompClient.subscribe('/topic/public', function(message) {
                console.log('ğŸ“¨ ë©”ì‹œì§€ ìˆ˜ì‹ :', message.body);
                const chatMessage = JSON.parse(message.body);
                displayMessage(chatMessage);
                
                // ì ‘ì†ì ìˆ˜ ì—…ë°ì´íŠ¸
                if (chatMessage.messageType === 'JOIN') {
                    onlineUsers.add(chatMessage.username);
                    console.log('ğŸ‘¤ ì‚¬ìš©ì ì…ì¥:', chatMessage.username);
                } else if (chatMessage.messageType === 'LEAVE') {
                    onlineUsers.delete(chatMessage.username);
                    console.log('ğŸ‘‹ ì‚¬ìš©ì í‡´ì¥:', chatMessage.username);
                }
                updateOnlineCount();
            });
            
            console.log('=== WebSocket ì„¤ì • ì™„ë£Œ ===');
        }, function(error) {
            console.error('âŒ WebSocket ì—°ê²° ì‹¤íŒ¨:', error);
            // ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ë” ì¹œí™”ì ìœ¼ë¡œ ë³€ê²½
            console.log('WebSocket ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. ì´ëŠ” ì •ìƒì ì¸ ìƒí™©ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        });
        }

        // ë©”ì‹œì§€ ì „ì†¡ (sendButtonì´ ì¡´ì¬í•˜ëŠ” ê²½ìš°ì—ë§Œ)
        const sendButton = document.getElementById('sendButton');
        if (sendButton) {
            sendButton.addEventListener('click', function() {
                sendMessage();
            });
        }

        // Enter í‚¤ë¡œ ë©”ì‹œì§€ ì „ì†¡ (messageInputì´ ì¡´ì¬í•˜ëŠ” ê²½ìš°ì—ë§Œ)
        const messageInput = document.getElementById('messageInput');
        if (messageInput) {
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        }

        // íƒ€ì´í•‘ ìƒíƒœ ì „ì†¡ (messageInputì´ ì¡´ì¬í•˜ëŠ” ê²½ìš°ì—ë§Œ)
        if (messageInput) {
            messageInput.addEventListener('input', function() {
                if (stompClient) {
                    // íƒ€ì´í•‘ ìƒíƒœë¥¼ ì„œë²„ë¡œ ì „ì†¡ (ê°„ë‹¨í•œ êµ¬í˜„)
                    clearTimeout(typingTimer);
                    typingTimer = setTimeout(() => {
                        // íƒ€ì´í•‘ ì¢…ë£Œ
                    }, 1000);
                }
            });
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            if (!messageInput) return;
            
            const message = messageInput.value.trim();
            
            if (message && stompClient) {
                const chatMessage = {
                    username: username,
                    message: message,
                    messageType: 'CHAT'
                };
                
                stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(chatMessage));
                messageInput.value = '';
            }
        }

        function displayMessage(message) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', message.messageType.toLowerCase());
            
            // ì„œë²„ì—ì„œ ë°›ì€ ì‹œê°„ ì‚¬ìš© (ë” ì •í™•í•¨)
            const messageTime = message.createdAt ? 
                new Date(message.createdAt).toLocaleTimeString('ko-KR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                }) : 
                new Date().toLocaleTimeString('ko-KR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            
            messageElement.innerHTML = `
                <div class="message-content">
                    <span class="message-username">${message.username}</span>
                    <span class="message-text">${message.message}</span>
                    <span class="message-time">${messageTime}</span>
                </div>
            `;
            
            messagesContainer.appendChild(messageElement);
            
            // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ ì´ë™ (ìƒˆ ë©”ì‹œì§€ê°€ ë³´ì´ë„ë¡)
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            console.log('ìƒˆ ë©”ì‹œì§€ í‘œì‹œ:', message.username, message.message);
        }
        
        // ì ‘ì†ì ìˆ˜ ì—…ë°ì´íŠ¸
        function updateOnlineCount() {
            console.log('=== ì ‘ì†ì ìˆ˜ ì—…ë°ì´íŠ¸ ===');
            console.log('í˜„ì¬ ì ‘ì†ì ëª©ë¡:', Array.from(onlineUsers));
            console.log('ì ‘ì†ì ìˆ˜:', onlineUsers.size);
            
            const onlineCountElement = document.getElementById('online-count');
            if (onlineCountElement) {
                onlineCountElement.textContent = onlineUsers.size;
                console.log('âœ… ì ‘ì†ì ìˆ˜ UI ì—…ë°ì´íŠ¸ ì™„ë£Œ:', onlineUsers.size);
            } else {
                console.error('âŒ online-count ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                console.log('í˜ì´ì§€ì—ì„œ online-count IDë¥¼ ê°€ì§„ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        }
        
        // WebSocket ì—°ê²° ìƒíƒœ í™•ì¸ ë° ì •ë¦¬ í•¨ìˆ˜
        function cleanupWebSocket() {
            if (stompClient && username) {
                console.log('WebSocket ì •ë¦¬ ì‹œì‘:', username);
                
                // Heartbeat ì •ë¦¬
                if (heartbeatInterval) {
                    clearInterval(heartbeatInterval);
                    heartbeatInterval = null;
                }
                
                // í‡´ì¥ ë©”ì‹œì§€ ì „ì†¡ (ì—ëŸ¬ ë¬´ì‹œ)
                try {
                    if (stompClient.connected) {
                        stompClient.send("/app/chat.addUser", {}, JSON.stringify({
                            username: username,
                            messageType: 'LEAVE'
                        }));
                        console.log('í‡´ì¥ ë©”ì‹œì§€ ì „ì†¡ ì„±ê³µ');
                    }
                } catch (e) {
                    console.log('í‡´ì¥ ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨ (ì •ìƒ):', e.message);
                }
                
                // WebSocket ì—°ê²° ì¢…ë£Œ
                try {
                    if (stompClient.connected) {
                        stompClient.disconnect();
                        console.log('WebSocket ì—°ê²° ì¢…ë£Œ');
                    }
                } catch (e) {
                    console.log('WebSocket ì—°ê²° ì¢…ë£Œ ì‹¤íŒ¨ (ì •ìƒ):', e.message);
                }
                
                stompClient = null;
                username = null;
            }
        }

        // í˜ì´ì§€ ì¢…ë£Œ ì‹œ í‡´ì¥ ë©”ì‹œì§€ ì „ì†¡ (í˜„ëŒ€ì ì¸ ë°©ë²•)
        window.addEventListener('pagehide', function() {
            cleanupWebSocket();
        });
        
        // ì¶”ê°€ì ì¸ í‡´ì¥ ì²˜ë¦¬ (visibilitychange ì´ë²¤íŠ¸)
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                cleanupWebSocket();
            }
        });

        // beforeunload ì´ë²¤íŠ¸ë„ ì¶”ê°€ (ë” ì•ˆì „í•œ ì •ë¦¬)
        window.addEventListener('beforeunload', function() {
            cleanupWebSocket();
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
        window.addEventListener('load', function() {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        });
    </script>
</body>
</html>